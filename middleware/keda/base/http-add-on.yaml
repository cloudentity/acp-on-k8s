apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: http-add-on
spec:
  releaseName: http-add-on
  chart:
    spec:
      chart: keda-add-ons-http
      sourceRef:
        kind: HelmRepository
        name: keda
        namespace: keda
      version: 0.6.0 # helm:autoupdate:keda-add-ons-http-prod
  interval: 1m
  install:
    remediation:
      retries: 3
  # Default values
  # https://github.com/kedacore/charts/blob/main/http-add-on/values.yaml
  values:
    operator:
      nodeSelector:
        system: "true"
      tolerations:
        - key: system
          value: "true"
          effect: NoSchedule
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: name
                    operator: In
                    values:
                      - keda-add-ons-http-controller-manager
              topologyKey: "kubernetes.io/hostname"
    scaler:
      nodeSelector:
        system: "true"
      tolerations:
        - key: system
          value: "true"
          effect: NoSchedule
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: name
                    operator: In
                    values:
                      - keda-add-ons-http-external-scaler
              topologyKey: "kubernetes.io/hostname"
    interceptor:
      nodeSelector:
        system: "true"
      tolerations:
        - key: system
          value: "true"
          effect: NoSchedule
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: name
                    operator: In
                    values:
                      - keda-add-ons-http-interceptor
              topologyKey: "kubernetes.io/hostname"
    crds:
      install: false
